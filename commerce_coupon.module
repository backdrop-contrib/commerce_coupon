<?php

/*
 * Implements hook_flush_caches().
 */
function commerce_coupon_flush_caches() {
  module_load_install('commerce_coupon');
  commerce_coupon_install_helper();
}

/*
 * Implements hook_entity_info().
 */
function commerce_coupon_entity_info() {
  $entity_info['commerce_coupon'] = array(
    'label' => t('Commerce Coupon'),
    'plural label' => t('Commerce Coupons'),
    'controller class' => 'CommerceCouponEntityController',
    'metadata controller class' => 'CommerceCouponMetadataController',
    'base table' => 'commerce_coupon',
    'fieldable' => TRUE,
    'entity keys' => array(
      'id' => 'coupon_id',
      'label' => 'code',
      'bundle' => 'type'
    ),
    'module' => 'commerce_coupon',
    'token type' => 'commerce-coupon',
    'permission labels' => array(
      'singular' => t('coupon'),
      'plural' => t('coupons'),
    ),
    'access callback' => 'commerce_entity_access',
    'access arguments' => array(
      'user key' => 'uid',
      'access tag' => 'commerce_coupon_access',
    ),
  );

  return $entity_info;
}

/*
 * Implements hook_entity_info_alter().
 */
function commerce_coupon_entity_info_alter(&$entity_info) {
  // Expose the admin UI for coupon fields.
  foreach (commerce_coupon_get_types() as $type => $info) {
    $entity_info['commerce_coupon']['bundles'][$type] = array(
      'admin' => array(
        'path' => 'admin/commerce/coupons/types/' . strtr($type, '_', '-'),
        'access arguments' => array('administer coupon types'),
      ),
      'label' => $info['label']
    );
  }
}

/*
 * Gets a list of all coupon types by invoking a hook.
 */
function commerce_coupon_get_types() {
  $cache = &drupal_static('commerce_coupon_type_info');

  if (!isset($cache)) {
    $cache = module_invoke_all('commerce_coupon_type_info');
  }

  return $cache;
}

/**
 * Returns the name of the specified coupon type or all names keyed by type if
 * no type is specified.
 *
 * @param $type
 *   Optional parameter specifying the type whose name to return.
 *
 * @return CouponType Either the specified name, defaulting to the type
 *  itself if the name is not found, or an array of all names keyed by type if no type is passed in.
 */
function commerce_coupon_type_get_name($type = NULL) {
  $coupon_types = commerce_coupon_get_types();

  // Return a type name if specified and it exists.
  if (!empty($type)) {
    if (isset($coupon_types[$type])) {
      return $coupon_types[$type]['label'];
    }
    else {
      // Return FALSE if it does not exist.
      return FALSE;
    }
  }

  // Otherwise turn the array values into the type name only.
  foreach ($coupon_types as $key => $value) {
    $coupon_types[$key] = $value['label'];
  }

  return $coupon_types;
}

/*
 * Implements hook_commerce_coupon_type_info().
 */
function commerce_coupon_commerce_coupon_type_info() {
  $types['discount_coupon'] = array(
    'label' => t('Discount coupon'),
  );

  return $types;
}

/*
 * Implements hook_menu().
 */
function commerce_coupon_menu() {
  // Find coupon auto-complete
  $items['commerce/coupons/find'] = array(
    'title' => 'Find coupon',
    'page callback' => 'commerce_coupon_find_coupon_autocomplete',
    'type' => MENU_CALLBACK,
    'access arguments' => array('View any commerce_coupon of any type')
  );

  // Remove coupon from order.
  $items['commerce/coupons/order/remove/%commerce_coupon/%commerce_order'] = array(
    'title' => 'Delete coupon from order',
    'page callback' => 'commerce_coupon_remove_coupon_from_order_callback',
    'page arguments' => array(4, 5),
    'access arguments' => array('access checkout'),
    'type' => MENU_CALLBACK,
  );

  // Edit & Delete coupon forms.
  $items['admin/commerce/coupons/%commerce_coupon'] = array(
    'title' => 'Edit',
    'page callback' => 'commerce_coupon_coupon_form_wrapper',
    'page arguments' => array(3, 'edit'),
    'access callback' => 'commerce_coupon_access',
    'access arguments' => array('update', 3),
    'weight' => 0,
    'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
  );
  $items['admin/commerce/coupons/%commerce_coupon/edit'] = array(
    'title' => 'Edit',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
    'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
    'access callback' => 'commerce_coupon_access',
    'access arguments' => array('update', 3),      
  );
  $items['admin/commerce/coupons/%commerce_coupon/delete'] = array(
    'title' => 'Delete',
    'page callback' => 'commerce_coupon_coupon_delete_form_wrapper',
    'page arguments' => array(3),
    'access callback' => 'commerce_coupon_access',
    'access arguments' => array('delete', 3),
    'type' => MENU_LOCAL_TASK,
    'weight' => 20,
    'context' => MENU_CONTEXT_INLINE,
  );

  // Coupon types.
  $items['admin/commerce/coupons/types'] = array(
    'title' => 'Coupon types',
    'description' => 'Manage coupon types for your store.',
    'file' => 'includes/commerce_coupon.admin.inc',
    'page callback' => 'commerce_coupon_types_overview_page',
    'access arguments' => array('administer coupon types'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 0,
  );

  // Add coupon
  $items['admin/commerce/coupons/add'] = array(
    'title' => 'Create Coupon',
    'description' => 'Create a new coupon',
    'page callback' => 'commerce_coupon_add_page',
    'page arguments' => array(commerce_coupon_create('discount_coupon')),
    'weight' => 10,
    'access callback' => 'commerce_coupon_access',
    'access arguments' => array('create', 'discount'),
    'file' => 'includes/commerce_coupon.admin.inc',
  );

  foreach (commerce_coupon_get_types() as $type => $coupon_type) {
    // Convert underscores to hyphens for the menu item argument.
    $type_arg = strtr($type, '_', '-');

    // Edit page
    $items['admin/commerce/coupons/types/' . $type_arg] = array(
      'title' => $coupon_type['label'],
      'page callback' => 'drupal_get_form',
      'page arguments' => array('commerce_coupon_type_settings_form', $coupon_type),
      'access arguments' => array('administer coupons'),
      'file' => 'includes/commerce_coupon.admin.inc',
    );

    $items['admin/commerce/coupons/types/' . $type_arg . '/edit'] = array(
      'title' => 'Edit',
      'access arguments' => array('administer coupons'),
      'type' => MENU_DEFAULT_LOCAL_TASK,
      'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
    );

    // Add pages
    $items['admin/commerce/coupons/add/' . $type_arg] = array(
      'title' => 'Create !label',
      'title arguments' => array('!label' => $coupon_type['label']),
      'description' => isset($coupon_type['description']) ? $coupon_type['description'] : '',
      'page callback' => 'commerce_coupon_coupon_form_wrapper',
      'page arguments' => array(commerce_coupon_create($type)),
      'access callback' => 'commerce_coupon_access',
      'access arguments' => array('create', commerce_coupon_create($type)),
      'file' => 'includes/commerce_coupon.admin.inc',
    );
  }

  return $items;
}

/*
 * Implements hook_form_FORM_ID_alter().
 */
function commerce_coupon_form_commerce_discount_operation_form_alter(&$form, &$form_state) {
  if ($form_state['op'] == 'delete') {
    // See if there are any coupons referencing this discount.
    $discount_wrapper = entity_metadata_wrapper('commerce_discount', $form_state['commerce_discount']);
    if ($discount_wrapper->coupons->count()) {
      $form['description']['#markup'] = t('This discount cannot be deleted because it has coupons referencing it. Try disabling it instead, or deleting the coupons first.');
      unset($form['actions']['submit']);
    }
  }
}

/*
 * Implements hook_theme().
 */
function commerce_coupon_theme() {
  return array(
    'commerce_coupon_type_admin_overview' => array(
      'variables' => array('coupon_type' => NULL),
    ),
    'commerce_coupon_manage_discount_coupons' => array(
      'render element' => 'elements'
    ),
    'commerce_coupon_discount_coupons_summary' => array(
      'render element' => 'element'
    ),
    'commerce_coupon_add_list' => array(
      'render element' => 'content'
    )
  );
}

/*
 * Menu callback: find coupon by code autocomplete
 */
function commerce_coupon_find_coupon_autocomplete($string = '') {
  $return = array();
  $query = new EntityFieldQuery;
  $results = $query
    ->entityCondition('entity_type', 'commerce_coupon')
    ->propertyCondition('code', $string, 'CONTAINS')
    ->propertyOrderBy('code')
    ->range(0, 3)
    ->execute();

  if (!empty($results['commerce_coupon'])) {
    $coupons = commerce_coupon_load_multiple(array_keys($results['commerce_coupon']));
    foreach ($coupons as $coupon) {
      $return[$coupon->code] = $coupon->code;
    }
  }

  drupal_json_output($return);
}

/*
 * Implements hook_menu_alter().
 */
function commerce_coupon_menu_alter(&$items) {
  // Transform the field UI tabs into contextual links.
  foreach (commerce_coupon_get_types() as $type => $coupon_type) {
    // Convert underscores to hyphens for the menu item argument.
    $type_arg = strtr($type, '_', '-');
    $items['admin/commerce/coupons/types/' . $type_arg . '/fields']['context'] = MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE;
    $items['admin/commerce/coupons/types/' . $type_arg . '/display']['context'] = MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE;
  }
}

/*
 * Implements hook_menu_local_tasks_alter().
 */
function commerce_coupon_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  // Add action link 'admin/commerce/products/add' on 'admin/commerce/products'.
  if ($root_path == 'admin/commerce/coupons') {
    $item = menu_get_item('admin/commerce/coupons/add');
    if ($item['access']) {
      $data['actions']['output'][] = array(
        '#theme' => 'menu_local_action',
        '#link' => $item,
      );
    }
  }
}

/*
 * Implements hook_admin_menu_map().
 */
function commerce_coupon_admin_menu_map() {
  // Add awareness to the administration menu of the various product types so
  // they are included in the dropdown menu.
  $type_args = array();

  foreach (array_keys(commerce_coupon_get_types()) as $type) {
    $type_args[] = strtr($type, '_', '-');
  }

  $map['admin/commerce/coupons/types/%'] = array(
    'parent' => 'admin/commerce/coupons/types',
    'arguments' => array(
      array('%' => $type_args),
    ),
  );

  return $map;
}

/*
 * Implements hook_permission().
 */
function commerce_coupon_permission() {
  
  foreach (commerce_coupon_get_types() as $type => $info) {
    $permissions['redeem coupons of type ' . $type] = array(
      'title' => t('Redeem any %type coupon', array('%type' => $info['label']))
    );       
  }

  $permissions += commerce_entity_access_permissions('commerce_coupon');

  return $permissions;
}

/**
 * Implements hook_query_TAG_alter().
 */
function commerce_coupon_query_commerce_coupon_access_alter(QueryAlterableInterface $query) {
  $tables = &$query->getTables();
  
  // Find the commerce_coupon table.
  foreach ($tables as $table) {
    if ($table['table'] === 'commerce_coupon') {
      $coupon_alias = $table['alias'];
      return commerce_entity_access_query_alter($query, 'commerce_coupon', $coupon_alias);
    }
  }
}

/**
 * Checks coupon access for various operations.
 *
 * @param $op
 *   The operation being performed. One of 'view', 'update', 'create' or
 *   'delete'.
 * @param $coupon
 *   Optionally a coupon to check access for. If nothing is given access
 *   permissions for all coupons are returned.
 * @param $account
 *   The user to check for. Leave it to NULL to check for the current user.
 */
function commerce_coupon_access($op, $coupon = NULL, $account = NULL) {
  return commerce_entity_access($op, $coupon, $account, 'commerce_coupon');
}

/*
 * Page wrapper: coupon add/edit form
 */
function commerce_coupon_coupon_form_wrapper($coupon) {
  module_load_include('inc', 'commerce_coupon', 'includes/commerce_coupon.admin');

  return drupal_get_form('commerce_coupon_form', $coupon);
}

/*
 * Page wrapper: coupon delete confirmation form
 */
function commerce_coupon_coupon_delete_form_wrapper($coupon) {
  module_load_include('inc', 'commerce_coupon', 'includes/commerce_coupon.admin');

  return drupal_get_form('commerce_coupon_delete_form', $coupon);
}

/*
 * Page callback: remove a coupon from an order and redirect back to
 * destination.
 */
function commerce_coupon_remove_coupon_from_order_callback($coupon, $order) {
  if (!isset($_GET['token']) || !drupal_valid_token($_GET['token'], 'commerce_coupon_remove_checkout:' . $coupon->coupon_id . ':' . $order->order_id) || !commerce_checkout_access($order)) {
    return MENU_ACCESS_DENIED;
  }

  commerce_coupon_remove_coupon_from_order($order, $coupon);
  drupal_set_message(t('Coupon removed from order'));
  drupal_goto();
}

/*
 * Implements hook_commerce_discount_rule_build().
 */
function commerce_coupon_commerce_discount_rule_build($rule, $discount) {
  $discount_wrapper = entity_metadata_wrapper('commerce_discount', $discount);

  // Determine whether the discount has coupon references
  if ($discount_wrapper->coupons->value()) {
    // Product level discounts must pass the line item's order.
    $map = array(
      'order_discount' => 'commerce-order',
      'product_discount' => 'commerce-line-item:order'
    );

    if (isset($map[$discount->type])) {
      $rule->condition('commerce_coupon_order_has_discount_coupon_code', array(
        'order:select' => $map[$discount->type],
        'commerce_discount' => $discount->name)
      );
    }
  }
}



/*
 * Entity metadata getter: coupon properties on discounts
 */
function commerce_coupon_get_discount_properties($discount, $options, $name) {
    switch ($name) {
      case 'coupons':
        if (!empty($discount->discount_id)) {
          // Load coupons that reference this discount.
          $query = new EntityFieldQuery;
          $results = $query
            ->entityCondition('entity_type', 'commerce_coupon')
            ->fieldCondition('commerce_discount_reference', 'target_id', $discount->discount_id)
            ->execute();

          if (isset($results['commerce_coupon'])) {
            return array_keys($results['commerce_coupon']);
          }
        }
        return array();

        break;
      case 'coupon_count':
        if (!empty($discount->discount_id)) {
          $query = new EntityFieldQuery;
          return $query
            ->entityCondition('entity_type', 'commerce_coupon')
            ->fieldCondition('commerce_discount_reference', 'target_id', $discount->discount_id)
            ->propertyCondition('status', 1)
            ->count()
            ->execute();
        }
        return 0;

        break;
    }
}

/*
 * Implements hook_commerce_checkout_pane_info().
 */
function commerce_coupon_commerce_checkout_pane_info() {
  $panes['commerce_coupon'] = array(
    'title' => t('Coupons'),
    'file' => 'includes/commerce_coupon.checkout_pane.inc',
    'base' => 'commerce_coupon_pane',
    'page' => 'checkout',
    'fieldset' => TRUE,
    'locked' => FALSE,
  );

  return $panes;
}

/**
 * Generates a new unique coupon code.
 *
 * @param $length
 *   Optional The length of the new code.
 * @return String
 *   The new coupon code.
 */
function commerce_coupon_generate_coupon_code($type, $length = NULL) {
  // We define the possible characters. No 'l','1', 'i' to prevent
  // reconisation problems.
  $characters = array(
    'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M',
    'N', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
    'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'j', 'k', 'm', 'n',
    'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',
    '2', '3', '4', '5', '6', '7', '8', '9',
  );

  $numberOfCharacters = count($characters);
  $codeFound = FALSE;
  if ($length == NULL) {
    $length = variable_get('commerce_coupon_' . $type . '_default_code_size', 8);
  }

  // We need to check if the produced coupon code is already in the
  // database. We try this for 1000 iteration. If we then not found a
  // a code, we stop. There must be an error in this case.
  for ($i = 0; $i < 1000 && $codeFound == FALSE; $i++) {
    $code = '';

    // Create the code per character
    for ($c = 0; $c < $length; $c++) {
      $randIndex = mt_rand(0, $numberOfCharacters - 1);
      $code .= $characters[$randIndex];
    }

    // Check in the database if the generated code is already defined.
    if (commerce_coupon_code_exists($code) == FALSE) {
      $codeFound = TRUE;
    }
  }

  return $code;
}

/**
 * Determine whether a coupon may be applied to an order. This function will set
 * error messages if necessary.
 *
 * @param type $coupon
 * @param type $order
 * @return boolean
 */
function commerce_coupon_may_redeem_coupon_code($code, $order) {
  // Trim trailing spaces
  $code = trim($code);
  $coupon = commerce_coupon_load_by_code($code);
  $errors = array();

  if (!$coupon || !$coupon->status) {
    $error = t('Your coupon code is not valid.');
  }

  // The same coupon cannot be added twice.
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  foreach ($order_wrapper->commerce_coupons as $order_coupon_wrapper) {
    if ($order_coupon_wrapper->coupon_id->value() == $coupon->coupon_id) {
      $error = t('The coupon you have entered has already been applied to your order');
      break;
    }
  }
  
  // Check user permissions.
  if ($coupon && !user_access('redeem coupons of type ' . $coupon->type)) {
    $error = t('You cannot redeem this code.');
  }

  // Allow other modules to alter whether a coupon is acceptable to redeem for
  // this order.
  drupal_alter('commerce_coupon_coupon_may_redeem', $error, $coupon, $order);
  
  if (!empty($error)) {
    drupal_set_message($error, 'error');
  }
  else {
    return TRUE;
  }
}

/**
 * Apply a coupon to an order.
 *
 * @param $coupon
 *   The coupon to redeem.
 * @param $order
 *   The order on which the coupon should be redeemed.
 * @return void
 */
function commerce_coupon_redeem_coupon_code($code, $order) {
  $coupon = commerce_coupon_load_by_code($code);

  // Add the coupon to the order.
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  $order_wrapper->commerce_coupons[] = $coupon;

  // Invoke a rule event and save order.
  rules_invoke_event('commerce_coupon_redeem', $coupon, $order);
  commerce_order_save($order);
  return TRUE;
}

/**
 * Loads a coupon by its coupon code.
 *
 * @param $code
 *   A code of a coupon.
 * @return
 *   A coupon object corresponding to the coupon code.
 */
function commerce_coupon_load_by_code($code) {
  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'commerce_coupon')
      ->propertyCondition('code', $code)
      ->addTag('DANGEROUS_ACCESS_CHECK_OPT_OUT') // TODO is this still necessary?
      ->execute();

  if (empty($result)) {
    return;
  }

  $commerce_coupon = reset($result['commerce_coupon']);
  return commerce_coupon_load($commerce_coupon->coupon_id);
}

/**
 * Load multiple function (should be added to commerce discounts).
 *
 * @param type $discount_ids
 * @param type $conditions
 * @param type $reset
 * @return type
 */
function commerce_coupon_discount_load_multiple($discount_ids, $conditions = array(), $reset = FALSE) {
  if (empty($discount_ids) && empty($conditions)) {
    return array();
  }

  return entity_load('commerce_discount', $discount_ids, $conditions, $reset);
}

/*
 * Create a stub coupon
 */
function commerce_coupon_create($type) {
  return entity_get_controller('commerce_coupon')->create(array('type' => $type));
}

/**
 * Fetch a coupon entity.
 *
 * @param $commerce_coupon_id
 *   Integer specifying the coupon id.
 * @param $reset
 *   A boolean indicating that the internal cache should be reset.
 * @return
 *   A fully-loaded $commerce_coupon object or FALSE if it cannot be loaded.
 *
 * @see commerce_coupon_load_multiple()
 */
function commerce_coupon_load($commerce_coupon_id, $reset = FALSE) {
  $commerce_coupons = commerce_coupon_load_multiple(array($commerce_coupon_id), array(), $reset);
  return reset($commerce_coupons);
}

/**
 *
 * @param type $coupon
 * @return type
 */
function commerce_coupon_save($coupon) {
  return entity_get_controller('commerce_coupon')->save($coupon);
}

/**
 * Deletes a coupon.
 *
 * @param $commerce_coupon_id
 *   Id of the coupon to delete.
 * @return void
 */
function commerce_coupon_delete($commerce_coupon_id) {
  return commerce_coupon_delete_multiple(array($commerce_coupon_id));
}

/**
 * Delete multiple coupons.
 *
 * @param $commerce_coupon_ids
 *   An array of coupon IDs.
 */
function commerce_coupon_delete_multiple(array $commerce_coupon_ids) {
  return entity_get_controller('commerce_coupon')->delete($commerce_coupon_ids);
}

/**
 * Load multiple coupons based on certain conditions.
 *
 * @param $commerce_coupon_ids
 *   An array of coupon IDs.
 * @param $conditions
 *   An array of conditions to match against the {commerce_coupon} table.
 * @param $reset
 *   A boolean indicating that the internal cache should be reset.
 * @return
 *   An array of coupon objects, indexed by coupon id.
 *
 * @see entity_load()
 * @see commerce_coupon_load()
 */
function commerce_coupon_load_multiple($commerce_coupon_ids = array(), $conditions = array(), $reset = FALSE) {
  if (empty($commerce_coupon_ids) && empty($conditions)) {
    return array();
  }

  return entity_load('commerce_coupon', $commerce_coupon_ids, $conditions, $reset);
}

/**
 * Checks if a given coupon code exists.
 *
 * @param $code
 *   Coupon code to check.
 *
 * @return boolean
 *   Returns TRUE if the coupon exists, otherwise return FALSE.
 */
function commerce_coupon_code_exists($code) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'commerce_coupon')
      ->propertyCondition('code', $code);

  $result = $query->execute();

  if (empty($result)) {
    return FALSE;
  }
  return TRUE;
}

/**
 * Returns the number of uses for this coupon.
 *
 * @param $coupon_id
 *   Coupon id to check.
 *
 * @return integer
 *   Returns number of uses of the coupon in all orders.
 */
function commerce_coupon_get_number_of_uses($coupon_id) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'commerce_order')
      ->fieldCondition('commerce_coupons', 'target_id', $coupon_id, '=');
  return $query->count()->execute();
}

/**
 * Finds out if a given coupon code is present in an order.
 *
 * @param $code
 *   Coupon code to check.
 * @param $order
 *   Commerce order object.
 *
 * @return boolean
 *   Returns TRUE if the coupon is in the order, otherwise return FALSE.
 */
function commerce_coupon_code_is_in_order($code, $order) {
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  foreach ($order_wrapper->commerce_coupon_order_reference as $coupon_wrapper) {
    if (strcasecmp($coupon_wrapper->code->value(), $code) == 0) {
      return TRUE;
    }
  }
  return FALSE;
}

/*
 * Implements hook_views_api().
 */
function commerce_coupon_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'commerce_coupon') . '/includes/views',
  );
}

/*
 * Implements hook_commerce_coupon_discount_savings_value_alter().
 */
function commerce_coupon_commerce_coupon_discount_value_display_alter(&$text, $discount, $order) {
  
  // Common variables
  $discount_wrapper = entity_metadata_wrapper('commerce_discount', $discount);  
  $offer_wrapper = $discount_wrapper->commerce_discount_offer;
  $offer_type = $offer_wrapper->type->value();
  $offer = $offer_wrapper->value();
  $discount_type = $discount_wrapper->type->value();

  $price_display = array(
    'type' => 'commerce_price_formatted_amount',
    'label' => 'hidden'
  );

  // Savings value implementations on behalf of commerce discount.
  switch ($discount_type) {
    case 'order_discount':
      switch ($offer_type) {
        case 'fixed_amount':
          $price = field_view_field('commerce_discount_offer', $offer, 'commerce_fixed_amount', $price_display);
          $text = drupal_render($price) . ' ' . t('from order');

          break;
        case 'percentage':
          $pct_display = field_view_field('commerce_discount_offer', $offer, 'commerce_percentage', 'default');
          $text = drupal_render($pct_display) . ' ' . t('from order');

          break;
        case 'free_shipping':
          $text = t('free shipping');

          break;
        case 'free_products':
          foreach ($offer_wrapper->commerce_free_products->value() as $product) {
            $product_names[] = check_plain($product->title);
          }
          if (isset($product_names)) {
            $product_text = implode(', ', $product_names);
          }

          $text = t('free product(s):') . ' ' . $product_text;
          break;
      }

      break;
    case 'product_discount':
      // By default, product discounts will show the value of the discount as
      // well as what product it is for, as defined in its inline conditions.
      $product_text = t('all products');
      $conditions = $discount_wrapper->inline_conditions->value();

      foreach($conditions as $condition) {
        if ($condition['condition_name'] == 'commerce_product_contains_products') {
          foreach ($condition['condition_settings']['sku'] as $data) {
            $product = commerce_product_load($data['product_id']);
            if ($product) {
              $product_names[] = check_plain($product->title);
            }
          }

          if (isset($product_names)) {
            $product_text = implode(', ', $product_names);
          }
          break;
        }
      }

      switch ($offer_type) {
        case 'fixed_amount':
          $offer_text = field_view_field('commerce_discount_offer', $offer, 'commerce_fixed_amount', $price_display);

          break;
        case 'percentage':
          $offer_text = field_view_field('commerce_discount_offer', $offer, 'commerce_percentage', 'default');

          break;
      }

      $text = drupal_render($offer_text) . ' ' . t('from') . ' ' . $product_text;

      break;
    default:
      // By default, just use the label.
      $text = check_plain($discount->label);

      break;
  }
}

/**
 * Load common discounts that are present in a coupon (by code) and an order.
 *
 * @param type $code
 * @param type $order
 * @return type
 */
function commerce_coupon_order_coupon_code_discounts($code, $order) {
  $coupon = commerce_coupon_load_by_code($code);
  $coupon_wrapper = entity_metadata_wrapper('commerce_coupon', $coupon);

  if ($coupon->type == 'discount_coupon' && $coupon_wrapper->commerce_discount_reference->value()) {

    // Line item level discounts are not stored on the order, so we have to dig
    // through the price components
    $order_discount_ids = commerce_coupon_order_discount_ids($order);
    $discount_ids = array_intersect($coupon_wrapper->commerce_discount_reference->raw(), $order_discount_ids);
    return commerce_coupon_discount_load_multiple($discount_ids);
  }

  return array();
}

/**
 * Determine whether an order has a particular discount.
 *
 * @param type $order
 * @param type $discount
 * @return type
 */
function commerce_coupon_order_has_discount($order, $discount) {
  $order_discount_ids = commerce_coupon_order_discount_ids($order);

  return in_array($discount->discount_id, $order_discount_ids);
}


/**
 * Determine whether an order has a particular coupon code.
 *
 * @param type $code
 * @param type $order
 * @return boolean
 */
function commerce_coupon_order_has_coupon_code($code, $order) {
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);

  foreach ($order_wrapper->commerce_coupons as $delta => $coupon_wrapper) {
    if ($coupon_wrapper->code->value() == $code) {
      return TRUE;
    }
  }
}

/**
 * Load all discounts connected to an order, including line item level discounts
 * traced through line item unit price components.
 *
 * @param type $order
 * @return array
 */
function commerce_coupon_order_discount_ids($order) {
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  $order_discount_ids = array();

  foreach ($order_wrapper->commerce_line_items as $line_item_wrapper) {
    $data = $line_item_wrapper->commerce_unit_price->data->value();

    foreach ($data['components'] as $key => $component) {
      if ($component['name'] == 'discount' || !empty($component['price']['data']['discount_name'])) {
        $order_discount_name = $component['price']['data']['discount_name'];
        $order_discount_wrapper = entity_metadata_wrapper('commerce_discount', $order_discount_name);
        // Make a list of discounts present via the order's line item price
        // components.
        $order_discount_ids[] = $order_discount_wrapper->discount_id->value();
      }
    }
  }

  // Add the set of discounts directly referenced on the order.
  foreach ($order_wrapper->commerce_discounts->raw() as $discount_id) {
    $order_discount_ids[] = $discount_id;
  }

  $order_discount_ids = array_unique($order_discount_ids);

  return $order_discount_ids;
}

/**
 * Load the discount associated with a coupon code.
 *
 * @param type $coupon
 */
function commerce_coupon_load_coupon_code_discounts($code) {
  $discounts = array();
  $coupon = commerce_coupon_load_by_code($code);

  $query = new EntityFieldQuery;
  $results = $query
    ->entityCondition('entity_type', 'commerce_discount')
    ->fieldCondition('commerce_coupon_reference', 'target_id', $coupon->coupon_id)
    ->propertyCondition('enabled', 1)
    ->execute();

  if (!empty($results['commerce_discount'])) {
    $discounts = entity_load('commerce_discount', array_keys($results['commerce_discount']));
  }
  return $discounts;
}

/**
 * Removes a coupon from an order.
 *
 * @param $order
 *   Order object to affect in the coupon removal.
 * @param $coupon
 *   Coupon object to remove.
 */
function commerce_coupon_remove_coupon_from_order($order, $coupon, $save = TRUE) {
  $original_order = clone $order;
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);

  // Remove the coupons from the order relationship.
  foreach ($order_wrapper->commerce_coupons as $delta => $coupon_wrapper) {
    if ($coupon_wrapper->coupon_id->value() == $coupon->coupon_id) {
      $order_wrapper->commerce_coupons->offsetUnset($delta);
    }
  }
  if ($original_order <> $order && $save) {
    commerce_order_save($order);
  }
}

/*
 * Implements hook_module_implements_alter().
 */
function commerce_coupon_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'commerce_cart_order_refresh') {
    // Move our implementation to the end of the list.
    $group = $implementations['commerce_coupon'];
    unset($implementations['commerce_coupon']);
    $implementations['commerce_coupon'] = $group;
  }
}

/*
 * Implements hook_commerce_cart_order_refresh
 */
function commerce_coupon_commerce_cart_order_refresh($order_wrapper) {
  $save = FALSE;
  $order = $order_wrapper->value();

  foreach ($order_wrapper->commerce_coupons->value() as $coupon) {
    // Invalidate coupons that exist on the order without their discount present
    // - meaning an inline condition on the discount was not satisfied.
    if ($coupon->type == 'discount_coupon' && !commerce_coupon_order_coupon_code_discounts($coupon->code, $order)) {
      drupal_set_message(t('One or more conditions for coupon @code are currently not satisfied.', array('@code' => $coupon->code)), 'error');
      $valid = FALSE;
    }
    else {
      // Other modules may set validity.
      $valid = TRUE;
      drupal_alter('commerce_coupon_coupon_is_valid', $valid, $coupon, $order);
    }
    if (!$valid) {
      // Remove invalid coupons
      commerce_coupon_remove_coupon_from_order($order, $coupon, FALSE);
      $save = TRUE;
    }
  }

  if ($save) {
    commerce_order_save($order);
  }
}

/**
 * Get the argument order if present.
 *
 * @param type $handler
 * @return type
 */
function _commerce_coupon_load_argument_order($handler) {
  // Determine if there is an order id argument. If multiple are present, use
  // the first found.
  if (isset($handler->view->argument)) {
    foreach ($handler->view->argument as $alias => $argument) {
      if ($argument instanceof commerce_order_handler_argument_order_order_id) {
        $order_id = (int) $handler->view->argument[$alias]->value[0];
        $order = commerce_order_load($order_id);
      }
    }
  }

  return isset($order) ? $order : FALSE;
}

/*
 * Implements hook_form_FORM_ID_alter().
 */
function commerce_coupon_form_commerce_discount_form_alter(&$form, &$form_state) {
  // Attach a UI for adding associated coupon entities.
  if (isset($form_state['triggering_element'])) {
    $trigger = end($form_state['triggering_element']['#array_parents']);
  }
  else {
    $trigger = NULL;
  }

  $form['#validate'][] = 'commerce_coupon_form_attach_coupons_validate';
  $form['#submit'][] = 'commerce_coupon_form_attach_coupons';

  // We do not want to show the management tools if there are more than 100
  // coupons attached to this discount.
  $discount_wrapper = entity_metadata_wrapper('commerce_discount', $form_state['commerce_discount']);
  $coupon_count = isset($form_state['coupons']) ? count($form_state['coupons']) : $discount_wrapper->coupon_count->value();
  if ($coupon_count <= 100) {
    // Keep track of coupons that have been added if there is a reasonably small
    // amount.
    if (!isset($form_state['coupons'])) {
      $form_state['coupons'] = $discount_wrapper->coupons->value();
      // Keep track of these so we know which to get rid of at the end.
      $form_state['original_coupons'] = $form_state['coupons'];
    }
    $coupons =& $form_state['coupons'];
  }

  // Handle certain triggers
  switch ($trigger) {
    case 'remove_coupon':
      $edit_delta = $form_state['triggering_element']['#delta'];
      unset($coupons[$edit_delta]);

      break;
    case 'edit_coupon':
      $edit_delta = $form_state['triggering_element']['#delta'];
      // Store the index of the coupon that we are editing.
      $form_state['edit_coupon'] = $coupons[$edit_delta];
      $form_state['edit_coupon']->delta = $edit_delta;

      break;
  }

  // Keep track of whether there is a coupon being edited currently.
  if (isset($form_state['edit_coupon'])) {
    $coupon = $form_state['edit_coupon'];
  }

  // Establish a container
  $form['coupons'] = array(
    '#type' => 'fieldset',
    '#title' => t('Coupon conditions'),
    '#tree' => TRUE,
    '#prefix' => '<div id="commerce-coupon-discount-coupon-form">',
    '#suffix' => '</div>'
  );

  // Ajax specifications.
  $ajax = array(
    'callback' => 'commerce_coupon_discount_coupon_form_ajax',
    'wrapper' => 'commerce-coupon-discount-coupon-form'
  );

  // Add new coupons
  $form['coupons']['add'] = array(
    '#type' => 'button',
    '#value' => t('Add new coupon'),
    '#ajax' => $ajax,
    '#limit_validation_errors' => array(array('coupons', 'coupon_form'))
  );

  // Find/add existing coupon
  $form['coupons']['add_existing'] = array(
    '#type' => 'button',
    '#value' => t('Add existing coupon'),
    '#ajax' => $ajax,
    '#limit_validation_errors' => array(array('coupons', 'find_coupon_code'))
  );

  if ($trigger == 'add') {
    $coupon = commerce_coupon_create('discount_coupon');

    $form['coupons']['coupon_form'] = array(
      '#type' => 'container'
    );
    // Attach the coupon form
    commerce_coupon_attach_ajax_coupon_entity_form(
      $form['coupons']['coupon_form'],
      $form_state,
      $coupon,
      $ajax,
      array(array('coupons'))
    );

    // Add responsive visibility states to the code line
    $form['coupons']['coupon_form']['code']['#states'] = array(
      'disabled' => array(
        'input[name="coupons[coupon_form][generate]"]' => array('checked' => TRUE)
      )
    );

    $form['coupons']['coupon_form']['save_coupon']['#limit_validation_errors'] = array(
      array('coupons', 'coupon_form')
    );
    unset($form_state['edit_coupon']);
  }
  else if ($trigger == 'add_existing') {
    $form['coupons']['find_coupon_code'] = array(
      '#type' => 'textfield',
      '#title' => t('Add existing coupon code'),
      '#autocomplete_path' => 'commerce/coupons/find',
    );
    // Add existing button
    $form['coupons']['add_existing_coupon'] = array(
      '#type' => 'button',
      '#value' => t('Add'),
      '#ajax' => $ajax,
      '#limit_validation_errors' => array(
        array('coupons', 'find_coupon_code')
      )
    );
    // Cancel add existing button
    $form['coupons']['cancel_add_existing'] = array(
      '#type' => 'button',
      '#value' => t('Cancel'),
      '#ajax' => $ajax,
      '#limit_validation_errors' => array()
    );
  }

  // Attach coupons management table
  $form['coupons']['manage_coupons'] = array(
    '#theme' => 'commerce_coupon_manage_discount_coupons',
  );

  if (isset($coupons)) {
    foreach ($coupons as $delta => $coupon) {
      $form['coupons']['manage_coupons'][$delta]['#coupon'] = $coupon;
      if (isset($edit_delta) && $delta == $edit_delta) {
        // If this one is selected, attach a coupon form
        $form['coupons']['manage_coupons'][$delta]['coupon_form'] = array(
          '#type' => 'container'
        );
        commerce_coupon_attach_ajax_coupon_entity_form(
          $form['coupons']['manage_coupons'][$delta]['coupon_form'],
          $form_state,
          $coupon,
          $ajax,
          array(array('coupons', 'manage_coupons', $delta))
        );

        // Add responsive visibility states to the code line
        $form['coupons']['manage_coupons'][$delta]['coupon_form']['code']['#states'] = array(
          'disabled' => array(
            'input[name="coupons[manage_coupons][' . $delta .'][coupon_form][generate]"]' => array('checked' => TRUE)
          )
        );
      }
      else {
        $form['coupons']['manage_coupons'][$delta]['edit_coupon'] = array(
          '#type' => 'button',
          '#ajax' => $ajax,
          '#value' => t('edit'),
          '#limit_validation_errors' => array(),
          '#delta' => $delta,
          '#name' => 'edit-coupon-' . $delta,
        );
        $form['coupons']['manage_coupons'][$delta]['remove_coupon'] = array(
          '#type' => 'button',
          '#ajax' => $ajax,
          '#value' => t('remove'),
          '#limit_validation_errors' => array(),
          '#delta' => $delta,
          '#name' => 'remove-coupon-' . $delta,
        );
      }
    }
  }
  else {
    // This means there are too many coupons for the management widget to
    // handle. Provide a summary.
    $form['coupons']['coupons_summary'] = array(
      '#theme' => 'commerce_coupon_discount_coupons_summary',
      '#count' => $coupon_count,
    );
  }

  // Clear the input if save was successful
  unset($form_state['values']['coupons']['coupon_form']);
  unset($form_state['input']['coupons']['coupon_form']);

  $form_state['coupons'] = $coupons;
}

/*
 * Form submit callback: save a coupon from the discount UI
 */
function commerce_coupon_form_attach_coupons(&$form, &$form_state) {
  if (!empty($form_state['coupons']) && !empty($form_state['commerce_discount']->discount_id)) {
    // Save coupons
    foreach ($form_state['coupons'] as $coupon) {
      if ($coupon->coupon_id || !commerce_coupon_load_by_code($coupon->code)) {
        // Add a reference to this discount.
        $coupon_wrapper = entity_metadata_wrapper('commerce_coupon', $coupon);
        $delta = $coupon_wrapper->commerce_discount_reference->count();
        $coupon->commerce_discount_reference[LANGUAGE_NONE][$delta]['target_id'] = $form_state['commerce_discount']->discount_id;

        // Save coupon.
        commerce_coupon_save($coupon);
      }
    }
  }

  // Remove coupons
  if (!empty($form_state['original_coupons'])) {
    foreach ($form_state['original_coupons'] as $original_coupon) {
      if (!commerce_coupon_coupon_list_has_code($original_coupon->code, $form_state['coupons'])) {
        // If the coupon code is no longer attached to this discount and it is
        // attached to no other discounts, delete it completely.
        $remove_coupon = commerce_coupon_load_by_code($original_coupon->code);
        $wrapper = entity_metadata_wrapper('commerce_coupon', $remove_coupon);
        $delete = TRUE;

        if (!empty($form_state['commerce_discount']->discount_id)) {
          foreach ($wrapper->commerce_discount_reference->value() as $discount) {
            if ($discount->discount_id != $form_state['commerce_discount']->discount_id) {
              $delete = FALSE;
            }
          }
        }

        if ($delete) {
          commerce_coupon_delete($original_coupon->coupon_id);
        }
      }
    }
  }

  // Rebuild the rules again.
  entity_defaults_rebuild(array('rules_config'));
}

/*
 * Form validate callback: validate a new coupon from the discount UI
 */
function commerce_coupon_form_attach_coupons_validate(&$form, &$form_state) {
  $trigger = end($form_state['triggering_element']['#array_parents']);

  switch ($trigger) {
    case 'add_coupon':
    case 'save_coupon':
      $coupon = !isset($form_state['edit_coupon']) ? commerce_coupon_create('discount_coupon') : $form_state['edit_coupon'];

      // Determine whether it is the "add new" form or an edit form
      if (isset($coupon->delta)) {
        $coupon_fields_form =& $form['coupons']['manage_coupons'][$coupon->delta]['coupon_form']['commerce_coupon_fields'];
        $coupon_values = $form_state['values']['coupons']['manage_coupons'][$coupon->delta]['coupon_form'];
      }
      else {
        $coupon_fields_form =& $form['coupons']['coupon_form']['commerce_coupon_fields'];
        $coupon_values = $form_state['values']['coupons']['coupon_form'];
      }

      // Validate fields
      field_attach_form_validate('commerce_coupon', $coupon, $coupon_fields_form, $form_state);

      // If the form has passed validation, prepare the coupon for submission.
      if (!form_get_errors()) {
        if (!empty($coupon_values['generate'])) {
          // Generate a code.
          $code = commerce_coupon_generate_coupon_code('discount_coupon');

          // Make sure the code is not already staged.
          if (!empty($form_state['coupons'])) {
            foreach ($form_state['coupons'] as $staged_coupon) {
              $coupon_codes[] = $staged_coupon->code;
            }
            $n = 0;
            while (in_array($code, $coupon_codes) && $n < 10) {
              $code = commerce_coupon_generate_coupon_code('discount_coupon');
              $n++;
            }
          }
        }
        else {
          $code = $coupon_values['code'];
        }

        $coupon->code = $code;
        $coupon->status = $coupon_values['status'];
        $coupon->uid = $coupon_values['uid'];

        field_attach_submit('commerce_coupon', $coupon, $coupon_fields_form, $form_state);
        // Add it to the list of coupons that we save.
        if (isset($coupon->delta)) {
          $form_state['coupons'][$coupon->delta] = $coupon;
          // If the coupon is already in the database, we must save it
          // immediately. This is to take care of cases where a user could
          // switch the codes of two coupons. If we allow the database to get
          // out of sync with what is in the form, it becomes prohibitively
          // difficult to enforce uniqueness.
          if (isset($coupon->coupon_id)) {
            commerce_coupon_save($coupon);
          }
        }
        else {
          $form_state['coupons'][] = $coupon;
        }

        // Reset the edit coupon tracker
        unset($form_state['edit_coupon']);
      }

      break;
    case 'cancel_coupon':
      unset($form_state['edit_coupon']);

      break;
    case 'add_existing_coupon':
      $code = $form_state['values']['coupons']['find_coupon_code'];
      $coupon = commerce_coupon_load_by_code($code);
      if (!$coupon) {
        form_set_error('coupons][find_coupon_code', t('Please enter a valid coupon code'));
      }
      else if (commerce_coupon_coupon_list_has_code($coupon->code, $form_state['coupons'])) {
        form_set_error('coupons][find_coupon_code', t('The coupon code you entered has already been added to this discount.'));
      }
      else {
        $form_state['coupons'][] = $coupon;
      }
      break;
  }
}

/**
 * Helper function to determine whether or not a list of coupons contains a
 * particular code.
 *
 * @param type $code
 * @param type $coupons
 * @return boolean
 */
function commerce_coupon_coupon_list_has_code($code, $coupons) {
  foreach ($coupons as $coupon) {
    if ($coupon->code == $code) {
      return TRUE;
    }
  }
}

/*
 * Form ajax callback: handle ajax rebuilding for all discount coupon form
 * operations.
 */
function commerce_coupon_discount_coupon_form_ajax(&$form, &$form_state) {
  return $form['coupons'];
}

/**
 * Attach an ajax coupon entity form to a form or form fragment.
 *
 * @param type $form
 * @param type $form_state
 * @param type $coupon
 * @param type $show_discounts_field
 */
function commerce_coupon_attach_ajax_coupon_entity_form(&$form, &$form_state, $coupon, $ajax, $limit_validation_errors, $show_discounts_field = FALSE) {
  commerce_coupon_attach_coupon_entity_form($form, $form_state, $coupon, $show_discounts_field);

  $form['code']['#element_validate'][] = 'commerce_coupon_code_validate_staged';

  $form['cancel_coupon'] = array(
    '#type' => 'button',
    '#value' => t('Cancel'),
    '#ajax' => $ajax,
    '#limit_validation_errors' => array()
  );

  $form['save_coupon'] = array(
    '#type' => 'button',
    '#value' => t('Save'),
    '#ajax' => $ajax,
    '#limit_validation_errors' => $limit_validation_errors
  );
}

/*
 * Form validate callback: make sure that the code entered is not the same as a
 * coupon code staged in the form.
 */
function commerce_coupon_code_validate_staged($element, &$form_state) {
  $code = $element['#value'];
  $coupon_form_values = drupal_array_get_nested_value($form_state['values'], array_slice($element['#array_parents'], 0, -1));
  $generate = $coupon_form_values['generate'];

  if (isset($form_state['coupons']) && !$generate) {
    $element_delta = $element['#array_parents'][2];
    foreach ($form_state['coupons'] as $delta => $coupon) {
      // Make sure that this code isn't used in one of the staged coupons.
      if ($code == $coupon->code && $delta != $element_delta) {
        form_set_error(implode('][', $element['#array_parents']), t('The code that you entered already exists.'));
      }
    }
  }
}

/**
 * Attach a coupon entity form to a form or form fragment.
 *
 * @param type $form
 * @param type $form_state
 * @param type $coupon
 */
function commerce_coupon_attach_coupon_entity_form(&$form, &$form_state, $coupon, $show_discounts_field = FALSE) {

  // Coupon code
  $form['code'] = array(
    '#type' => 'textfield',
    '#title' => t('Coupon code'),
    '#default_value' => $coupon->code,
    '#coupon_id' => isset($coupon->coupon_id) ? $coupon->coupon_id : '',
    '#element_validate' => array('commerce_coupon_validate_code'),
  );

  // Generate code
  $form['generate'] = array(
    '#type' => 'checkbox',
    '#title' => t('Generate code'),
    '#description' => t('If you check this, a random code will be generated.'),
    '#default_value' => FALSE,
  );
    
  $form['uid'] = array(
    '#type' => 'value',
    '#value' => !empty($coupon->is_new) ? 0 : $coupon->uid
  );

  $form['commerce_coupon_fields'] = array(
    '#type' => 'container',
  );

  // Attach fields.
  field_attach_form('commerce_coupon', $coupon, $form['commerce_coupon_fields'], $form_state);

  // Possibly do not show the discount reference field
  if (!$show_discounts_field) {
    $form['commerce_coupon_fields']['commerce_discount_reference']['#access'] = 0;
  }

  // Status
  $form['status'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enabled'),
    '#default_value' => $coupon->status,
  );
  
  // Allow other modules to alter this form whereever it appears.
  drupal_alter('commerce_coupon_coupon_entity_form', $form, $form_state, $coupon);
}

/*
 * Theme callback: build discount coupon management table
 */
function theme_commerce_coupon_manage_discount_coupons($variables) {
  $elements = $variables['elements'];
  $table['headers'] = array(t('Code'), '', '');
  $table['rows'] = array();

  foreach (element_children($elements) as $delta) {
    $element = $elements[$delta];
    if (isset($element['edit_coupon']) && isset($element['remove_coupon'])) {
      $edit_button = $element['edit_coupon'];
      $remove_button = $element['remove_coupon'];

      $row = array(check_plain($element['#coupon']->code), drupal_render($edit_button), drupal_render($remove_button));
    }
    else {
      $form = $element['coupon_form'];
      $row = array(drupal_render($form));
    }
    $table['rows'][] = $row;
  }

  if (!empty($table['rows'])) {
    return theme('table', $table);
  }
}

/*
 * Theme callback: render discount coupons summary
 */
function commerce_coupon_discount_coupons_summary($variables) {
  $output = '<div class="commerce-coupon-discount-coupons-summary"><strong>';
  $output .= t('Attached coupons');
  $output .= ':</strong>';
  $output .= check_plain($variables['element']['#count']) . '</div>';
}

/*
 * Element validate callback: validate coupon code
 */
function commerce_coupon_validate_code($element, &$form_state) {
  $path = implode('][', $element['#array_parents']);
  $coupon_form_values = drupal_array_get_nested_value($form_state['values'], array_slice($element['#array_parents'], 0, -1));
  // Ensure code is not empty unless we are generating a random one
  if (empty($coupon_form_values['generate'])) {
    if (empty($element['#value'])) {
      form_set_error($path, t('You must enter a code.'));
      return;
    }

    $code = $element['#value'];

    // Do not allow existing coupon codes, unless it is merely saving itself.
    $coupon = commerce_coupon_load_by_code($code);

    if ($coupon && (empty($element['#coupon_id']) || $element['#coupon_id'] != $coupon->coupon_id)) {
      form_set_error($path, t('The code that you entered already exists.'));
    }
  }

  // Ensure unique code if inserting
  if (!empty($form_state['edit_coupon']->is_new) && commerce_coupon_load_by_code($element['#value'])) {
    form_set_error($path, t('The code that you entered already exists.'));
  }
}
